# -*- coding: utf-8 -*-
"""dataset_jw.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tnv7bXWZfVBa1DEGDNBNsgSGbyMSlkPy
"""

import os
import pandas as pd
from PIL import Image
from torch.utils.data import Dataset
from typing import Optional, Dict, Any, Tuple

class DeepFashionC2S(Dataset):
    """
    DeepFashion Consumer-to-Shop Dataset Loader
    - consumer & shop ì´ë¯¸ì§€ pair ë¡œë”©
    - bbox crop ì§€ì›
    """

    def __init__(self, csv_path: str, img_root: str, transform=None, split: str = "train"):
        # ì „ì²´ CSV ì½ê¸°
        self.df = pd.read_csv(csv_path)

        # split ì ìš© (train / val / test)
        self.df = self.df[self.df["split"] == split].reset_index(drop=True)

        self.img_root = img_root
        self.transform = transform

    def __len__(self):
        return len(self.df)

    def load_crop(self, img_path: str, x1: int, y1: int, x2: int, y2: int) -> Image.Image:
        """ì´ë¯¸ì§€ ë¡œë“œ í›„ bbox crop"""
        full_path = os.path.join(self.img_root, img_path)

        # os.path.existsë¥¼ í†µí•´ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì„ í–‰ í™•ì¸ (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ëª…ì‹œì  í™•ì¸ì— ë„ì›€)
        if not os.path.exists(full_path):
             raise FileNotFoundError(f"File not found at path: {full_path}")

        img = Image.open(full_path).convert("RGB")
        crop = img.crop((x1, y1, x2, y2))
        return crop

    # ğŸš¨ ë°˜í™˜ íƒ€ì…ì„ Noneì„ í¬í•¨í•˜ë„ë¡ ë³€ê²½ (Optional[Dict[str, Any]])
    def __getitem__(self, idx: int) -> Optional[Dict[str, Any]]:
        row = self.df.iloc[idx]

        try:
            # consumer ì´ë¯¸ì§€ crop
            cons_img = self.load_crop(
                row['consumer_path'],
                row['cons_x1'], row['cons_y1'], row['cons_x2'], row['cons_y2']
            )

            # shop ì´ë¯¸ì§€ crop
            shop_img = self.load_crop(
                row['shop_path'],
                row['shop_x1'], row['shop_y1'], row['shop_x2'], row['shop_y2']
            )

            # transform ì ìš©
            if self.transform:
                cons_img = self.transform(cons_img)
                shop_img = self.transform(shop_img)

            return {
                "consumer": cons_img,
                "shop": shop_img,
                "item_id": row["item_id"],
                "consumer_path": row["consumer_path"],
                "shop_path": row["shop_path"]
            }

        except FileNotFoundError:
            # ğŸš¨ [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ì„ ì°¾ì§€ ëª»í•˜ë©´ Noneì„ ë°˜í™˜í•˜ê³  ë‹¤ìŒ ìƒ˜í”Œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
            # ë¬¸ì œê°€ ë˜ëŠ” ì¬ê·€ í˜¸ì¶œ (return self.__getitem__(next_idx)) ë¡œì§ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
            print(f"[WARNING] File not found for sample at index {idx}. Skipping this sample.")
            return None # Noneì„ ë°˜í™˜í•˜ì—¬ DataLoaderê°€ collate_fnì„ í†µí•´ ì´ ìƒ˜í”Œì„ ê±´ë„ˆë›°ê²Œ í•¨