# -*- coding: utf-8 -*-
"""dataset_jw.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1tnv7bXWZfVBa1DEGDNBNsgSGbyMSlkPy
"""

import os
import pandas as pd
from PIL import Image
from torch.utils.data import Dataset
from typing import Optional, Dict, Any


class DeepFashionC2S(Dataset):
    """
    DeepFashion Consumer-to-Shop Dataset Loader
    - consumer & shop 이미지 pair 로딩
    - bbox crop + margin 지원
    """

    def __init__(
        self,
        csv_path: str,
        img_root: str,
        transform=None,
        split: str = "train",
        margin_ratio: float = 0.0,   # 추가: margin 비율 (0.0, 0.1, 0.2)
    ):
        # 전체 CSV 읽기
        self.df = pd.read_csv(csv_path)

        # split 적용 (train / val / test)
        self.df = self.df[self.df["split"] == split].reset_index(drop=True)

        self.img_root = img_root
        self.transform = transform
        self.margin_ratio = margin_ratio#마진 저장 

    def __len__(self):
        return len(self.df)

    def apply_margin(self, x1, y1, x2, y2, img_w, img_h):
        """bbox에 margin 비율 적용"""
        w = x2 - x1
        h = y2 - y1

        margin_w = w * self.margin_ratio
        margin_h = h * self.margin_ratio

        new_x1 = max(0, x1 - margin_w)
        new_y1 = max(0, y1 - margin_h)
        new_x2 = min(img_w, x2 + margin_w)
        new_y2 = min(img_h, y2 + margin_h)

        return int(new_x1), int(new_y1), int(new_x2), int(new_y2)

    def load_crop(self, img_path: str, x1: int, y1: int, x2: int, y2: int) -> Image.Image:
        """이미지 로드 후 bbox(+margin) crop"""
        full_path = os.path.join(self.img_root, img_path)

        # 파일 존재 검사
        if not os.path.exists(full_path):
            raise FileNotFoundError(f"File not found at path: {full_path}")

        img = Image.open(full_path).convert("RGB")
        img_w, img_h = img.size

        # margin 적용
        x1, y1, x2, y2 = self.apply_margin(x1, y1, x2, y2, img_w, img_h)

        crop = img.crop((x1, y1, x2, y2))
        return crop

    def __getitem__(self, idx: int) -> Optional[Dict[str, Any]]:
        row = self.df.iloc[idx]

        try:
            # consumer 이미지 crop
            cons_img = self.load_crop(
                row['consumer_path'],
                row['cons_x1'], row['cons_y1'], row['cons_x2'], row['cons_y2']
            )

            # shop 이미지 crop
            shop_img = self.load_crop(
                row['shop_path'],
                row['shop_x1'], row['shop_y1'], row['shop_x2'], row['shop_y2']
            )

            # transform 적용
            if self.transform:
                cons_img = self.transform(cons_img)
                shop_img = self.transform(shop_img)

            return {
                "consumer": cons_img,
                "shop": shop_img,
                "item_id": row["item_id"]
            }

        except FileNotFoundError:
            print(f"[WARNING] File not found for sample at index {idx}. Skipping this sample.")
            return None
